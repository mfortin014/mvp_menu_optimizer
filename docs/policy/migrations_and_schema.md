# Migrations & Schema Discipline
**Updated:** 2025-09-18 21:20

Purpose: keep database drift under control while the MVP evolves. Pair with `dump_schema.sh` and the RLS specs before altering data models.

---

## Source of Truth

### MVP now
- **Migrations:** append-only SQL files under `migrations/sql/` named `V###__short_desc.sql`.
- **Schema snapshot:** `schema/current/prod.schema.sql` reflects production after the most recent release.
- **Release history:** each shipped version gets a frozen dump in `schema/releases/` (generated by `dump_schema.sh`).

### v1 later
- Managed migrations (Alembic/Flyway) and automated schema diffs will backfill GitHub discussions before execution.
- Additional schema slices (analytics, reporting replicas) get their own directories and policies.

---

## Authoring a Migration

### MVP now
1. Create a new SQL file with the next sequence number (`V015__add_example_table.sql`).  
2. Write **idempotent** statements: guard `CREATE` with `IF NOT EXISTS`, prefer views over data rewrites.  
3. Include rollback notes in the file header comment (manual until we adopt reversible tooling).  
4. Test locally against a disposable Supabase instance before opening a PR.  
5. Document the change in the relevant spec or changelog entry.

### v1 later
- Codify forward/rollback scripts per migration and run them through automated CI sandboxes.  
- Introduce migration linting (check for locks, `SET ROLE`, etc.).

---

## Refreshing Schema Dumps

### MVP now
- Never hand-edit files under `schema/`.  
- After deploying a migration, run `./dump_schema.sh` pointing at production, then:
  - Replace `schema/current/prod.schema.sql` with the new dump.
  - Append a versioned copy to `schema/releases/` (e.g., `schema/releases/mvp-0.7.0.schema.sql`).
- Keep prior dumps in `schema/archive/` (ignored by Git) if you need scratch history.

### v1 later
- Automate schema refresh on release tagging and attach dumps to GitHub Releases.  
- Maintain per-environment snapshots (staging/prod) for diffing in CI.

---

## Data Safety

- Avoid destructive ops (`DROP`, `DELETE`) unless the accompanying spec approves it.  
- Seed data lives under `data/sample_data/`; the lightweight fixtures for tests live in `data/sample/` (no secrets).  
- When altering reference data, update the relevant source `.md` documents (Data Dictionary, changelog).

